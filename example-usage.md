## Set Up
Make sure that the client and the server VM is properly set up. Follow the [instruction](https://github.com/JBoerma/hmc-clinic-msft-2020#install) to finish seting up.
In the *Server VM*, run the following command to launch the servers (while inside the `install` directory)
```
./restart-all.sh
```
In the *Client VM*, run the following command to initialize network namespace for emulating conditions. This is to separate the SSH to the Azure from the SSH connection between Client and Server VM. 
```
./install/namespace.sh
```
Choose a network device when prompted. The newly created network namespace will be called *netns0*.

## Create Simulation
If we want to measure the timing of a connection over HTTP/3, we conduct an experiment using the *Client VM* and *Server VM*. 
The experiment.py script simulates an interaction between *Client VM* and *Server VM*, where the *Client VM* requests a file from *Server VM*.

```bash
experiment.py [--device DEVICE] [--conditions CONDITIONS ...] [--browsers BROWSERS ...] [--url URL] [--runs RUNS] [--out OUT] [--throughput THROUGHPUT] [--payloads PAYLOADS] [--ports PORTS ...] [options]
```

The users need to provide information to the fields below to properly simulate the connection:

```
--device                  The device to modify              [e.g. veth-netns0]
--conditions              The network condition to simulate [e.g. 4g-lte-good 3g-unts-good, a complete list of network condition]
--browsers                The browser that the Client uses  [e.g. edge, firefox, chromium]
--endpoints               The server?                       [e.g. 
                                                              private: server-nginx, server-nginx-quiche, server-caddy, server-openlitespeed,
                                                              public:  facebook, google, cloudflare]
--payloads                The file requested by the Client  [e.g. 10kb.html, small, medium, large]
--out                     The database to save the data     [e.g. results/data.db]
```

Optional fields to provide the users with more flexibility in controling the details of the experiments, or simply in debugging.

```
--disable_caching         Disables caching
--warmup                  Warms up connection
--async                   Run experiment asynchronously, use with throughout
--throughout              Number of requests per connection
--qlog                    Turns on QLog logging
--pcap                    Turns on Packet Capture with TShark
--runs                    Number of data points
```

### Example 

#### Requesting to public endpoints

For example, if the user wants to request a small file from Google, in a moderately good network condition, and the user wants to repeat this experiment 10 times, the command to run is:

```bash
python3 experiment.py 
                      --device eth0
                      --browsers firefox 
                      --conditions 4g-lte-good 
                      --out results/data.db 
                      --endpoint google
                      --payload small
                      --runs 10
```
#### Requesting to private vitual servers

For example, if the user wants to request a medium-size file from the private server NGINX, in a moderately lossy network condition, and the user wants to repeat this experiment 10 times, the command to run is:

```bash
sudo ip netns exec netns0 sudo -u $USER python3 experiment.py 
                      --device veth-netns0
                      --browsers firefox 
                      --conditions 3.5g-hspa-lossy 
                      --out results/March_XX_experiment.db 
                      --endpoint server-nginx
                      --payload medium
                      --runs 1000
```

## Collect Data

The output of the experiment will be stored in the *Client VM*, where the out field directs to. The data base records the requests parameters, network condition, and navigation timings, and the VM's server information like load average and IOwait. Below is a detailed documentation of waht is recorded.



|Table Name                                                        |Column Name               |Type              |Description                                                                                                                                                                                                                                              |FIELD5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |FIELD6                                                                                              |
|------------------------------------------------------------------|--------------------------|------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
|                                                                  |                          |                  |                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |                          |                  |                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|big_table                                                         |schemaVer                 |TEXT              |the version of the current schema                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |experimentID              |TEXT              |unix time. Different for each experiment                                                                                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |webPage                   |TEXT              |url                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |serverVersion             |TEXT              |(Nothing right now...) Should be the version of the server we're testing                                                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |gitHash                   |TEXT              |hash of current commit on hmc-clinic-msft-2020 repo                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|\--                                                               |condition                 |TEXT              |(UP TO DEBATE - code still coming in) - "condition" of network, determining netem params                                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |                          |                  |                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|processes                                                         |unixTime                  |INT               |the unix time when the data is collected                                                                                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |collected from the command "ps aux"                                                                 |
|                                                                  |user                      |TEXT              |the user account under which this process is running                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |https://www.computernetworkingnotes.com/linux-tutorials/ps-aux-command-and-ps-command-explained.html|
|                                                                  |pid                       |INT               |process ID of this process                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |CPUPercent                |Float             |CPU time used by this process (in precentage)                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |MemoryPercent             |Float             |physical memory used by this process (in percentage)                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |VSZ                       |INT               |virutal memory used by this process (in bytes)                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |RSS                       |INT               |resident set size, the non-s                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |TTY                       |TEXT              |Terminal from which this process is started. Question mark (?) sign represents that this process is not started from a terminal.                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |stat                      |TEXT              |Process state.                                                                                                                                                                                                                                           |D	uninterruptible sleep (usually IO) R	running or runnable (on run queue) S	interruptible sleep (waiting for an event to complete) T	stopped by job control signal t	stopped by debugger during the tracing w	paging (not valid since the 2.6.xx kernel) x	dead (should never be seen) Z	defunct ("zombie") process, terminated but not reaped by its parent < 	high-priority (not nice to other users) N	low-priority (nice to other users) L	has pages locked into memory (for real-time and custom IO) s	is a session leader l	is multi-threaded (using CLONE_THREAD, like NPTL pthreads do) +	is in the foreground process group|                                                                                                    |
|                                                                  |start                     |TEXT              |Starting time and date of this process                                                                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |Time                      |TEXT              |	Total CPU time used by this process                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |command                   |TEXT              |	The command with all its arguments which started this process                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |                          |                  |                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|timings                                                           |experimentID              |TEXT              |(same as in big_table)                                                                                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|\++                                                               |trafficLoad               |Float             |the number of requests in the traffic. eg: there are 10 requests being made at the same time (not an actuate representation for how crowded the network is, because the actual number of jobs waiting to be done in the queue depends on the exercution. |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|\++                                                               |pcap                      |TEXT              |the path of the packet capture file if there is one, "n/a" otherwise                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |browser                   |TEXT              |browser used (firefox &#124; chrome &#124; edge)                                                                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |server                    |TEXT              |server used (<server>/<server_version>)                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |httpVersion               |TEXT              |the version of the proctocal used by the connection                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |payloadSize               |TEXT              |the size of the webpage requested [1kb - 1mb]                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |warmup                    |BOOL              |whether the browser is warmed up before the requests are made                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |netemParams               |TEXT              |network condition                                                                                                                                                                                                                                        |https://www.browserstack.com/docs/automate/selenium/simulate-network-conditions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                    |
|                                                                  |startTime                 |Float             |startTime through loadEventEnd are described at https://developer.mozilla.org/en-US/docs/Web/API/Navigation_timing_API                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |fetchStart                |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |domainLookupStart         |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |domainLookupEnd           |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |connectStart              |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |secureConnectinStart      |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |connectEnd                |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |requestStart              |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |responseStart             |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |resonseEnd                |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |domInteractive            |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |domContentLoadedEventStart|Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |domContentLoadedEventEnd  |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |domComplete               |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |loadEventStart            |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |loadEventEnd              |Float             |^                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|\++                                                               |error                     |TEXT              |error that comes up during the request (if status is not 200, timeout error, tc command not set)                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|(has to do with our own stuff, as opposed to processes in general)|                          |                  |                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|monitoring                                                        |experimentID              |INT               |(same as above)                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |currentTime               |TEXT              |YYYY/MM/DD HH:MM:SS                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |unixTime                  |INT               |unix time                                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |currentProcNames          |JSON - LIST[TEXT] |process name                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |cpuTime                   |JSON - LIST[FLOAT]|how long has the process been running measured in sec                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |iowait                    |JSON - LIST[TEXT] |how long has the kernel suspended this process (while it works on other processes)                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |load_1                    |FLOAT             |average system load on a Linux server for 1 min                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |load_5                    |FLOAT             |average system load on a Linux server for 5 min                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |
|                                                                  |load_15                   |FLOAT             |average system load on a Linux server for 15 min                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                    |


## Data Analysis


